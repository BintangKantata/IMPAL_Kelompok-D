<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Order History - Cinemate</title>
  <link href="dist/output.css" rel="stylesheet">
  <style>
    body {
      background: radial-gradient(ellipse at top left, #0F1D22 0%, #0F1D22 60%, #152A30 100%);
      color: #fff;
      font-family: 'Montserrat', Arial, sans-serif;
      min-height: 100vh;
      margin: 0;
    }

    .header-nav {
      position: sticky;
      top: 0;
      background: radial-gradient(ellipse at top left, #0F1D22 0%, #0F1D22 60%, #152A30 100%);
      padding: 1.4rem 2.5rem;
      z-index: 10;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header-nav a {
      color: #fff;
      text-decoration: none;
      font-size: 1rem;
      transition: color 0.2s;
    }
    .header-nav a:hover {
      color: #5AC3E7;
    }

     .search-wrapper {
      position: relative;
    }

    .search-bar {
      padding: 0.6rem 1.2rem 0.6rem 3rem;
      border-radius: 999px;
      border: none;
      font-size: 1rem;
      color: #0F1D22;
      background: #fff;
      width: 320px; /* LEBAR */
    }

    .search-icon {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      color: #777;
      pointer-events: none;
    }

    .content {bar
          flex: 1;
          padding: 30px;
        }

        .content-wrapper {
          width: 60%;
          margin: 0 auto;
        }

    .main-title {
      font-size: 2em;
      font-weight: bold;
      font-family: 'Poppins', sans-serif;
      margin-bottom:1.2rem;
    }
    table {
          width: 100%;
          border-collapse: collapse;
          background: #fff;
          color: #0d0d0d;
          border-radius: 10px;
          overflow: hidden;
        }

        thead {
          background: #5AC3E7;
        }

        th, td {
          padding: 12px;
          border-bottom: 1px solid #1e293b;
        }

        /* PAKSA header table putih & rata kiri */
        table thead th {
          color: #ffffff !important;
          text-align: left !important;
        }

        table tbody td {
          color: #000000;
          text-align: left;
        }
    .barcode-btn {
      background: #5AC3E7;
      color: #23343B;
      border-radius: 0.5rem;
      padding: 0.45rem 1rem;
      font-weight: bold;
      border: none;
      cursor: pointer;
      font-size: 0.95rem;
      transition: background 0.2s, color 0.2s;
      text-decoration: none;
    }
    .barcode-btn:hover {
      background: #5AC3E7;
      color: #fff;
    }

    .pagination-wrapper {
          width: 100%;
          margin-top: 15px;

          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        #pagination {
          display: flex;
          flex-wrap: wrap;
        }

        #pagination button {
          margin: 0 4px;
          padding: 6px 10px;
          border: none;
          background: #020617;
          color: #cbd5f5;
          border-radius: 4px;
        }

        #pagination button:active {
          background: #5AC3E7;
          color: #020617;
        }

        #pagination button:disabled {
          opacity: 0.4;
        }
  </style>
</head>
<body>
  <header class="header-nav">
    <a href="homepage.html" class="no-underline">
      <div class="flex items-center space-x-3">
        <img src="https://img.icons8.com/ios-filled/50/ffffff/video-projector.png"
             class="w-10 h-10"
             alt="Logo Cinemate">
        <span class="text-white text-2xl font-bold tracking-wide">
        CINEMATE
      </span>
      </div>
    </a>

    <nav class="flex items-center space-x-6">
      <input
              type="text"
              id="searchInput"
              class="search-bar"
              placeholder="Search movies"
      />
    </nav>
  </header>
  <!-- Main Content -->
  <main class="content">
    <div class="content-wrapper">

    <!-- Riwayat Pemesanan -->
      <h1 class="main-title">Order History</h1>
      <table>
        <thead>
          <tr>
            <th>No.</th>
            <th>Movies</th>
            <th>F&B</th>
            <th>Location</th>
            <th>Date</th>
            <th>Time</th>
            <th>Ticket</th>
          </tr>
        </thead>
        <tbody id="historyBody"></tbody>
      </table>

      <div class="pagination-wrapper">
        <span id="pageInfo"></span>
        <div id="pagination"></div>
      </div>

    </div>
  </main>

  <script>
    window.API = window.API || "/api";
    const customerId = localStorage.getItem("customerId");

    if (!customerId) {
      alert("Silakan login terlebih dahulu");
      window.location.href = "login.html";
    }

    let allData = [];
    let filteredData = [];
    let currentPage = 1;
    const rowsPerPage = 10;


    const searchInput = document.getElementById("searchInput");

    searchInput.addEventListener("input", function () {
      const keyword = this.value.toLowerCase().trim();

      filteredData = allData.filter(item =>
        item.filmTitle.toLowerCase().includes(keyword)
      );

      currentPage = 1;
      renderTable();
    });


    async function loadOrderHistory() {
      try {
        const res = await fetch(`${API}/bookings/customers/${customerId}`);
        allData = await res.json();

        filteredData = [...allData];
        currentPage = 1;
        renderTable();

      } catch (err) {
        console.error("Gagal memuat riwayat:", err);
        alert("Gagal memuat riwayat pemesanan");
      }
    }


    function renderTable() {
      const tbody = document.getElementById("historyBody");
      tbody.innerHTML = "";

      if (!filteredData.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" style="text-align:center;color:#ccc;">
              Belum ada riwayat pemesanan
            </td>
          </tr>
        `;
        document.getElementById("pagination").innerHTML = "";
        document.getElementById("pageInfo").innerText = "Showing 0 of 0";
        return;
      }

      const start = (currentPage - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const pageData = filteredData.slice(start, end);

      renderRows(pageData);
      renderPagination(filteredData.length);

      const totalPages = Math.ceil(filteredData.length / rowsPerPage);
      pageInfo.innerText = `Showing page ${currentPage} of ${totalPages}`;
    }


    function renderRows(data) {
      const tbody = document.getElementById("historyBody");
      tbody.innerHTML = "";

      data.forEach((b, index) => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td>${(currentPage - 1) * rowsPerPage + index + 1}.</td>
          <td>${b.filmTitle}</td>
          <td>${b.fnbItems || "-"}</td>
          <td>${b.locationName}</td>
          <td>${formatDate(b.date)}</td>
          <td>${formatTime(b.time)}</td>
          <td>
            <a href="success.html?bookingId=${b.bookingId}"
               class="barcode-btn">
              View Ticket
            </a>
          </td>
        `;

        tbody.appendChild(tr);
      });
    }

    function renderPagination(totalItems) {
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";

      const totalPages = Math.ceil(totalItems / rowsPerPage);

      const prev = document.createElement("button");
      prev.innerText = "<";
      prev.disabled = currentPage === 1;
      prev.onclick = () => {
        currentPage--;
        renderTable();
      };
      pagination.appendChild(prev);

      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement("button");
        btn.innerText = i;

        if (i === currentPage) {
          btn.style.background = "#5AC3E7";
          btn.style.color = "#020617";
        }

        btn.onclick = () => {
          currentPage = i;
          renderTable();
        };

        pagination.appendChild(btn);
      }

      const next = document.createElement("button");
      next.innerText = ">";
      next.disabled = currentPage === totalPages;
      next.onclick = () => {
        currentPage++;
        renderTable();
      };
      pagination.appendChild(next);
    }

    function formatDate(dateStr) {
      const d = new Date(dateStr);
      return d.toLocaleDateString("id-ID");
    }

    function formatTime(timeStr) {
      return timeStr.slice(0, 5);
    }

    loadOrderHistory();
  </script>
</body>
</html>
