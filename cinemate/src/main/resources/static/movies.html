<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Film Page - Cinemate</title>
  <link href="dist/output.css" rel="stylesheet">
  <style>
    body {
      background: radial-gradient(ellipse at top left, #0F1D22 0%, #0F1D22 60%, #152A30 100%);
      color: #fff;
      font-family: 'Montserrat', Arial, sans-serif;
      min-height: 100vh;
      margin: 0;
    }
    .header-nav {
      position: sticky;
      top: 0;
      background: radial-gradient(ellipse at top left, #0F1D22 0%, #0F1D22 60%, #152A30 100%);
      padding: 1.4rem 2.5rem;
      z-index: 10;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header-nav a {
      color: #fff;
      text-decoration: none;
      font-size: 1rem;
      transition: color 0.2s;
    }
    .header-nav a:hover {
      color: #5AC3E7;
    }
    /* Carousel Styles */
    .carousel-section {
      width: 100vw;
      position: relative;
      left: 50%;
      right: 50%;
      margin-left: -50vw;
      margin-right: -50vw;
      overflow: hidden;
      margin-top: 0.5rem;
      margin-bottom: 2.5rem;
      background: rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      height: 410px;
      max-height: 56vw;
    }
    .carousel {
      width: 100vw;
      height: 410px;
      max-height: 56vw;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }
    .carousel-slide {
      display: none;
      width: 100vw;
      height: 410px;
      max-height: 56vw;
      position: absolute;
      left: 0;
      top: 0;
      justify-content: center;
      align-items: center;
      transition: opacity 0.7s;
      opacity: 0;
    }
    .carousel-slide.active {
      display: flex;
      opacity: 1;
      transition: opacity 0.7s;
    }
    .carousel-img-bg {
      width: 100vw;
      height: 410px;
      background-size: cover;
      background-position: center;
      filter: blur(0.5px) brightness(0.7);
      position: absolute;
      top: 0; left: 0;
      z-index: 0;
      transition: background-image 0.7s;
    }
    .carousel-content {
      position: relative;
      z-index: 2;
      display: flex;
      align-items: center;
      gap: 2.2rem;
      margin-left: 4vw;
    }
    .carousel-poster {
      width: 220px;
      height: 320px;
      object-fit: cover;
      border-radius: 1.5rem;
      box-shadow: 0 8px 42px 0 rgba(35,101,223,0.21);
    }
    .carousel-text {
      color: #fff;
      max-width: 500px;
      text-shadow: 0 2px 12px #23343Bcc;
      font-size: 1.07rem;
    }
    .carousel-title {
      font-size: 2.15rem;
      font-weight: 900;
      margin-bottom: 0.6rem;
      margin-top: 0.5rem;
      letter-spacing: 0.03em;
      line-height: 1.1;
    }
    .carousel-meta {
      font-size: 1.08rem;
      color: #5AC3E7;
      font-weight: 700;
      margin-bottom: 0.7rem;
      margin-top: 0.1rem;
    }
    .carousel-btn {
      background: #5AC3E7;
      color: #0d0d0d;
      font-size: 1rem;
      font-weight: bold;
      border-radius: 0.8rem;
      padding: 0.7rem 1.7rem;
      border: none;
      margin-top: 1.2rem;
      margin-bottom: 0.9rem;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
      text-decoration: none;
      display: inline-block;
    }
    .carousel-btn:hover {
      background: #5AC3E7;
      color: #fff;
    }
    .carousel-dots {
      position: absolute;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 0.8rem;
      z-index: 10;
    }
    .carousel-dot {
      width: 15px;
      height: 15px;
      border-radius: 50%;
      background: #5AC3E7;
      opacity: 0.5;
      cursor: pointer;
      transition: opacity 0.2s;
      border: 2px solid #36A7CE;
    }
    .carousel-dot.active {
      opacity: 1;
      background: #5AC3E7;
    }
    @media(max-width:1200px){
      .carousel-section, .carousel, .carousel-slide, .carousel-img-bg{height:32vw;max-height:32vw;}
      .carousel-poster{height:210px; width:140px;}
      .carousel-title{font-size:1.5rem;}
      .carousel-content{gap:1.3rem;}
    }
    @media(max-width:900px){
      .carousel-section, .carousel, .carousel-slide, .carousel-img-bg{height:38vw;max-height:38vw;}
      .carousel-poster{height:140px; width:90px;}
      .carousel-content{margin-left:2vw;}
      .carousel-title{font-size:1.1rem;}
      .carousel-meta{font-size:1rem;}
    }
    @media(max-width:600px){
      .carousel-section, .carousel, .carousel-slide, .carousel-img-bg{height:54vw;max-height:54vw;}
      .carousel-poster{height:90px; width:60px;}
      .carousel-content{flex-direction:column;align-items:flex-start;gap:0.6rem;}
      .carousel-title{font-size:0.9rem;}
      .carousel-meta{font-size:0.9rem;}
      .carousel-text{font-size:0.95rem;}
    }

    /* Filter Buttons */
    .genreFilter {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin: 0 2.5rem 2rem;
    }
    .filter-btn {
      background: #5AC3E7;
      color: #020617;
      font-weight: 600;
      border-radius: 0.7rem;
      font-size: 1rem;
      padding: 0.55rem 1.7rem;
      border: none;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
      margin-left: 41px;
      margin-bottom: 12px;
    }
    .filter-btn:hover,
    .filter-btn.active {
      background: #5AC3E7;
      color: #fff;
    }

    /* Movie Grid dan Card */
    .movie-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 40px;
      padding: 0 2.5rem 2rem;
    }
    .movie-item {
      width: 180px;
    }

    .movie-card {
      width: 100%;
      aspect-ratio: 2 / 3;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
    }

    .movie-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 8px 35px rgba(0,0,0,0.55);
    }

    .movie-poster {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .movie-info {
      margin-top: 8px;
      text-align: left;
    }

    .movie-title {
      font-size: 1rem;
      font-weight: 500;
      text-align: left;
      color: #fff;
      line-height: 1.2;
      margin-bottom: 0.4rem;
    }

    .movie-title-link {
      text-decoration: none;
    }

    .movie-tags {
      display: flex;
      justify-content: flex-start;
      gap: 0.55rem;
      font-size: 0.85rem;
      color: #ccc;
    }

    .movie-tag {
      background: rgba(255,255,255,0.08);
      padding: 0.15rem 0.45rem;
      border-radius: 4px;
      font-weight: 400;
      white-space: nowrap;
    }

    .rating-g {
      background: #22c55e;   /* hijau */
      color: #fff;
      font-weight: 400;
    }

    .rating-pg13 {
      background: #facc15;   /* kuning */
      color: #1f2937;
      font-weight: 400;
    }

    .rating-pg17 {
      background: #f97316;   /* oranye */
      color: #fff;
      font-weight: 400;
    }

    .rating-pg21 {
      background: #ef4444;   /* merah */
      color: #fff;
      font-weight: 400;
    }

    .rating-unknown {
      background: #64748b;   /* abu */
      color: #fff;
    }


    .section-title {
      margin-left: 41px;
      margin-bottom: 12px;
    }

    .search-wrapper {
      position: relative;
    }

    .search-bar {
      padding: 0.6rem 1.2rem 0.6rem 3rem;
      border-radius: 999px;
      border: none;
      font-size: 1rem;
      color: #0F1D22;
      background: #fff;
      width: 320px; /* LEBAR */
    }

    .search-icon {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      color: #777;
      pointer-events: none;
    }

  </style>

  <script>
    window.API = window.API || "http://localhost:8080/api";
    let carouselIndex = 0;
    let carouselTimer;
    let carouselMovies = [];
    let allMovies = [];
    let filmScheduleMap = {};
    let activeStatus = "NOW";

  function showCarousel(idx) {
    const slides = document.querySelectorAll('.carousel-slide');
    const dots = document.querySelectorAll('.carousel-dot');

    slides.forEach((slide, i) => {
      slide.classList.toggle('active', i === idx);
      dots[i].classList.toggle('active', i === idx);
    });

    carouselIndex = idx;
  }

  function nextCarousel() {
    carouselIndex = (carouselIndex + 1) % carouselMovies.length;
    showCarousel(carouselIndex);
  }

  function startCarousel() {
    carouselTimer = setInterval(nextCarousel, 3400);
  }

  function stopCarousel() {
    clearInterval(carouselTimer);
  }

  async function loadCarousel() {
    try {
      const res = await fetch("http://localhost:8080/api/admin/films");
      const movies = await res.json();

      // ambil 5 film pertama (atau sesuai kebutuhan)
      carouselMovies = movies.slice(0, 5);

      const carousel = document.getElementById('carousel');
      const dots = document.getElementById('carousel-dots');

      carousel.innerHTML = "";
      dots.innerHTML = "";

      carouselMovies.forEach((film, i) => {
        const genres = (film.genres || []).join("/");
        const duration = film.duration + "m";

        const slide = document.createElement('div');
        slide.className = 'carousel-slide' + (i === 0 ? ' active' : '');

        slide.innerHTML = `
          <div class="carousel-img-bg"
               style="background-image:url('${film.bannerImage || film.image}')"></div>
          <div class="carousel-content">
            <img src="${film.image}" class="carousel-poster" alt="${film.title}">
            <div class="carousel-text">
              <div class="carousel-title">${film.title}</div>
              <div class="carousel-meta">${genres} Â· ${duration}</div>
              <div>${film.description || ""}</div>
              <a href="filmdetail.html?id=${film.id}" class="carousel-btn">
                Show Detail
              </a>
            </div>
          </div>
        `;

        carousel.appendChild(slide);

        const dot = document.createElement('span');
        dot.className = 'carousel-dot' + (i === 0 ? ' active' : '');
        dot.onclick = () => {
          showCarousel(i);
          stopCarousel();
          startCarousel();
        };

        dots.appendChild(dot);
      });

      showCarousel(0);
      startCarousel();

    } catch (err) {
      console.error("Gagal load carousel:", err);
    }
  }

  async function loadMovies() {
    try {
      const filmRes = await fetch("http://localhost:8080/api/admin/films");

      if (!filmRes.ok) {
        throw new Error("Gagal mengambil film");
      }

      allMovies = await filmRes.json();
      filmScheduleMap = {};

      // cek schedule per film (SESUI CONTROLLER)
      await Promise.all(
        allMovies.map(async film => {
          try {
            const res = await fetch(
              `http://localhost:8080/api/admin/films/${film.id}/schedules`
            );
            const schedules = await res.json();
            filmScheduleMap[film.id] =
              Array.isArray(schedules) && schedules.length > 0;
          } catch {
            filmScheduleMap[film.id] = false;
          }
        })
      );

      applyFilters();

    } catch (err) {
      console.error("Gagal load film:", err);

      const container = document.querySelector(".movie-grid");
      if (container) {
        container.innerHTML = `
          <p style="color:#aaa;text-align:center;">
            Gagal memuat film
          </p>
        `;
      }
    }
  }

  function renderMovies(movies) {
    const grid = document.querySelector(".movie-grid");
    grid.innerHTML = "";

    if (!movies.length) {
      grid.innerHTML = `<p style="color:#aaa;text-align:center;">No movies found</p>`;
      return;
    }

    movies.forEach(film => {
      const duration = formatDuration(film.duration);
      const rating = film.ru || "-";
      const poster = film.image || "default-poster.jpg";

     grid.innerHTML += `
        <div class="movie-item">

          <!-- CARD POSTER -->
          <div class="movie-card" onclick="location.href='filmdetail.html?id=${film.id}'">
            <img
              src="${poster}"
              class="movie-poster"
              alt="${film.title}"
            >
          </div>

          <!-- INFO DI BAWAH CARD -->
          <div class="movie-info">
            <a class="movie-title-link">
              <h4 class="movie-title line-clamp-2">
                ${film.title}
              </h4>
            </a>

            <div class="movie-tags">
              <p class="movie-tag">2D</p>
              <p class="movie-tag rating-tag ${getRatingClass(rating)}">${rating}</p>
              <p class="movie-tag">${duration}</p>
            </div>
          </div>

        </div>
      `;
    });
  }

  function formatDuration(min) {
    const h = Math.floor(min / 60);
    const m = min % 60;
    return h ? `${h}h ${m}m` : `${m}m`;
  }



  function filmHasSchedule(filmId) {
    return filmScheduleMap[filmId] === true;
  }


  function applyFilters() {
    const selectedGenre = document.getElementById("genreFilter")?.value || "";
    const selectedAge = document.getElementById("ageFilter")?.value || "";
    const keyword =
      document.getElementById("searchInput")?.value.toLowerCase() || "";

    let filtered = [...allMovies];

    // NOW SHOWING / UPCOMING
    filtered = filtered.filter(film => {
      const hasSchedule = filmHasSchedule(film.id);
      return activeStatus === "NOW"
        ? hasSchedule
        : !hasSchedule;
    });

    // genre
    if (selectedGenre) {
      filtered = filtered.filter(film =>
        film.genres?.includes(selectedGenre)
      );
    }

    // rating usia
    if (selectedAge) {
      filtered = filtered.filter(film =>
        film.ru === selectedAge
      );
    }

    // search
    if (keyword) {
      filtered = filtered.filter(film =>
        film.title.toLowerCase().includes(keyword)
      );
    }

    renderMovies(filtered);
  }



  async function loadRecommendations() {
    const customerId = localStorage.getItem("customerId");
    if (!customerId) return;

    try {
      const bookingRes = await fetch(`${API}/bookings/customers/${customerId}`);
      const bookings = await bookingRes.json();

      if (!Array.isArray(bookings) || bookings.length === 0) return;

      const filmRes = await fetch(`${API}/admin/films`);
      const films = await filmRes.json();

      const watchedTitles = bookings.map(b => b.filmTitle);
      const preferredGenres = new Set();

      films.forEach(film => {
        if (watchedTitles.includes(film.title)) {
          (film.genres || []).forEach(g => preferredGenres.add(g));
        }
      });

      if (preferredGenres.size === 0) return;

      const recommendedFilms = films.filter(film =>
        !watchedTitles.includes(film.title) &&
        film.genres?.some(g => preferredGenres.has(g))
      );

      if (recommendedFilms.length === 0) return;

      renderRecommendations(recommendedFilms);

      console.log("Bookings:", bookings);
      console.log("Preferred genres:", [...preferredGenres]);

    } catch (err) {
      console.error("Gagal load rekomendasi:", err);
    }
  }

  function renderRecommendations(films) {
    const section = document.getElementById("recommendation-section");
    const grid = document.getElementById("recommendationGrid");

    section.style.display = "block";
    grid.innerHTML = "";

    films.slice(0, 6).forEach(film => {
      const duration = formatDuration(film.duration);
      const rating = film.ru || "-";
      const poster = film.image || "default-poster.jpg";

      grid.innerHTML += `
        <div class="movie-item">

          <div class="movie-card"
               onclick="location.href='filmdetail.html?id=${film.id}'">
            <img
              src="${poster}"
              class="movie-poster"
              alt="${film.title}">
          </div>

          <div class="movie-info">
            <h4 class="movie-title line-clamp-2">
              ${film.title}
            </h4>

            <div class="movie-tags">
              <p class="movie-tag">2D</p>
              <p class="movie-tag rating-tag ${getRatingClass(rating)}">
                ${rating}
              </p>
              <p class="movie-tag">${duration}</p>
            </div>
          </div>

        </div>
      `;
    });
  }

  function getRatingClass(rating) {
  switch (rating) {
    case "G":
      return "rating-g";
    case "PG13":
      return "rating-pg13";
    case "PG17":
      return "rating-pg17";
    case "PG21":
      return "rating-pg21";
    default:
      return "rating-unknown";
  }
}



  window.onload = function () {
    loadCarousel();
    loadMovies();
    loadRecommendations();

    document.getElementById("genreFilter")
      .addEventListener("change", applyFilters);

    document.getElementById("ageFilter")
      .addEventListener("change", applyFilters);

    document.getElementById("searchInput")
      ?.addEventListener("input", applyFilters);

    document.querySelectorAll(".filter-btn[data-status]")
    .forEach(btn => {
      btn.addEventListener("click", () => {

        document.querySelectorAll(".filter-btn[data-status]")
          .forEach(b => b.classList.remove("active"));

        btn.classList.add("active");
        activeStatus = btn.dataset.status;

        applyFilters();
      });
    });
  };

  </script>

</head>
<body>
<header class="header-nav">
  <a href="homepage.html" class="no-underline">
    <div class="flex items-center space-x-3">
      <img src="https://img.icons8.com/ios-filled/50/ffffff/video-projector.png"
           class="w-10 h-10"
           alt="Logo Cinemate">
      <span class="text-white text-2xl font-bold tracking-wide">
        CINEMATE
      </span>
    </div>
  </a>

  <nav class="flex items-center space-x-6">
    <input
            type="text"
            id="searchInput"
            class="search-bar"
            placeholder="Search movies"
    />
  </nav>
</header>

<main class="pt-8">
  <div class="carousel-section">
    <div class="carousel" id="carousel"></div>
    <div class="carousel-dots" id="carousel-dots"></div>
  </div>

  <div class="movie-filters">
    <button class="filter-btn active" data-status="NOW">
      Now Showing
    </button>
    <button class="filter-btn" data-status="UPCOMING">
      Upcoming
    </button>

    <select id="genreFilter" class="filter-btn" style="min-width:140px;">
      <option value="">None</option>
      <option value="ACTION">Action</option>
      <option value="ADVENTURE">Adventure</option>
      <option value="ANIMALS">Animals</option>
      <option value="ANIMATION">Animation</option>
      <option value="ANTHOLOGY">Anthology</option>
      <option value="ART">Art</option>
      <option value="BIOGRAPHY">Biography</option>
      <option value="COMEDY">Comedy</option>
      <option value="CRIME">Crime</option>
      <option value="CYBERPUNK">Cyberpunk</option>
      <option value="DISASTER">Disaster</option>
      <option value="DOCUMENTARY">Documentary</option>
      <option value="DRAMA">Drama</option>
      <option value="FAMILY">Family</option>
      <option value="FANTASY">Fantasy</option>
      <option value="FUTURISTIC">Futuristic</option>
      <option value="HISTORICAL">Historical</option>
      <option value="HORROR">Horror</option>
      <option value="MILITARY">Military</option>
      <option value="POLITICAL">Political</option>
      <option value="PSYCHOLOGICAL">Psychological</option>
      <option value="ROMANCE">Romance</option>
      <option value="SCHOOL">School</option>
      <option value="SCIENCE_FICTION">Science Fiction</option>
      <option value="SPACE">Space</option>
      <option value="STEAMPUNK">Steampunk</option>
      <option value="SUPERHERO">Superhero</option>
      <option value="SURVIVAL">Survival</option>
      <option value="THRILLER">Thriller</option>
      <option value="WILDLIFE">Wildlife</option>
      <option value="ZOMBIE">Zombie</option>
    </select>

    <select id="ageFilter" class="filter-btn" style="min-width:110px;">
      <option value="">None</option>
      <option value="G">G</option>
      <option value="PG13">PG-13</option>
      <option value="PG17">PG-17</option>
      <option value="PG21">PG-21</option>
    </select>
  </div>

  <div class="movie-grid">
  </div>

    <section id="recommendation-section" style="display:none;">
      <h2 class="section-title">YOU MIGHT LIKE</h2>
      <div class="movie-grid" id="recommendationGrid"></div>
    </section>

</main>
</body>
</html>
