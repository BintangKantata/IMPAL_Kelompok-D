<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Manage Film Schedules</title>
  <style>
    body {
     background: radial-gradient(circle at top left, #0e1a20 0%, #11252d 40%, #0d1418 100%);
      color: white;
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0 0 150px 0;
    }

    .page {
      max-width: 1100px;
      margin: auto;
      padding: 30px;
    }

    h2 {
      font-size: 28px;
      margin-bottom: 25px;
      color: #ffffff;
      font-weight: 700;
    }

    /* --- CARD INPUT --- */
    .card {
      background: rgba(255,255,255,0.10);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.4);
      margin-bottom: 25px;
    }

    label {
      font-weight: bold;
      display: block;
      margin-top: 12px;
      color: #ffffff;
    }

    input, select {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      background:rgba(255,255,255,0.18);
      border: 1px solid #2c3a40;
      color: white;
      margin-top: 6px;
    }

	input {
		width: 98%;
	}

	input[type="date"]::-webkit-calendar-picker-indicator {
    filter: invert(1);  /* 1 = putih, 0 = hitam */
	}

	input[type="time"]::-webkit-calendar-picker-indicator {
    filter: invert(1);  /* 1 = putih, 0 = hitam */
	}

    button {
      color: #fff;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
    }
    #btnAdd {
          padding: 10px 16px;
          border: none;
          background: #5AC3E7;
          color: #020617;
          border-radius: 6px;
          cursor: pointer;
          margin-bottom: 21px;
        }

        #btnAdd:hover{
          color: #fff;
        }

    /* --- TABLE --- */
     table {
          width: 100%;
          border-collapse: collapse;
          background: #fff;
          color: #0d0d0d;
          border-radius: 10px;
          overflow: hidden;
        }

        thead {
          background: #5AC3E7;
        }

        th, td {
          padding: 12px;
          border-bottom: 1px solid #1e293b;
        }

        /* PAKSA header table putih & rata kiri */
        table thead th {
          color: #ffffff !important;
          text-align: left !important;
        }

        table tbody td {
          color: #000000;
          text-align: left;
        }

        /* ===== ACTION BUTTON ===== */
        #edit-btn, #modalSave {
          background: #22c55e;
          border: none;
          padding: 6px 10px;
          margin-right: 5px;
          border-radius: 6px;
          cursor: pointer;
        }

        #edit-btn:hover {
          background: #46cf78;
        }

        #delete-btn, .delete-btn {
          background: #fa3e48;
          border: none;
          padding: 6px 10px;
          margin-right: 5px;
          border-radius: 6px;
          cursor: pointer;
        }

        #delete-btn:hover , .delete-btn:hover {
          background: #ff4d56;
        }

    #modalTitle {
      color: black;
      font-size: 28px;
    }

    #modalLocation, #modalAuditorium {
      color: black;
    }

    #modalTime, #modalDate {
      color: black;
      width: 94%;
    }

    .cancelBtn {
      width: 100%;
      margin-top: 10px;
      background: #b71c1c;
    }

    .cancelBtn:hover {
      background: #8b1111;
    }

    #editError {
      margin-top: 10px;
      padding: 8px;
      background: #b71c1c;
      border-radius: 6px;
    }

    .content-wrapper {
      width: 50%;
      margin: 0 auto;
      display: flex;
      flex-direction: column;   /* ⬅️ vertikal */
      align-items: flex-start;  /* ⬅️ rata kiri */
    }

    .pagination-wrapper {
          width: 100%;
          margin-top: 15px;

          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        #pagination {
          display: flex;
          flex-wrap: wrap;
        }


        #pagination button {
          margin: 0 4px;
          padding: 6px 10px;
          border: none;
          background: #020617;
          color: #cbd5f5;
          border-radius: 4px;
        }

        #pagination button:active {
          background: #5AC3E7;
          color: #020617;
        }

        #pagination button:disabled {
          opacity: 0.4;
        }

  </style>
</head>
<body>
<main class="content">
  <div class="content-wrapper">
<h2 id="filmTitle">Film Schedule</h2>

<div>
  <button id="btnAdd">+ Add Schedule</button>
</div>

<table>
  <thead>
  <tr>
    <th>ID</th>
    <th>Location</th>
    <th>Auditorium</th>
    <th>Date</th>
    <th>Time</th>
    <th>Actions</th>
  </tr>
  </thead>
  <tbody id="scheduleTable"></tbody>
</table>

    <div class="pagination-wrapper">
      <span id="pageInfo"></span>
      <div id="pagination"></div>
    </div>


    <!-- ADD / EDIT MODAL -->
    <div id="scheduleModal"
         style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.5); padding-top:100px; z-index:999;">
      <div style="margin:auto; background:white; padding:20px; width:400px; border-radius:8px;">
        <h3 id="modalTitle">Add Schedule</h3>

        <label style="color:black;">Location:</label>
        <select id="modalLocation"></select>

        <label style="color:black;">Auditorium:</label>
        <select id="modalAuditorium"></select>

        <label style="color:black;">Date:</label>
        <input type="date" id="modalDate">

        <label style="color:black;">Time:</label>
        <input type="time" id="modalTime">

        <div id="modalError" style="display:none;color:red"></div>

        <br><br>
        <button id="modalSave">Save</button>
        <button id="delete-btn"onclick="closeScheduleModal()">Cancel</button>
      </div>
    </div>
  </div>
</main>

<script>
  /* ===============================
     GLOBAL STATE
  ================================ */
  let filmId = null;
  let locations = [];
  let mode = "add";        // add | edit
  let editingId = null;
  let allSchedules = [];
  let currentPage = 1;
  const rowsPerPage = 10;


  const API_BASE = "http://localhost:8080/api/admin";

  const btnAdd = document.getElementById("btnAdd");
  const scheduleTable = document.getElementById("scheduleTable");

  /* ===============================
     MODAL ELEMENTS (ADD & EDIT)
  ================================ */
  const scheduleModal = document.getElementById("scheduleModal");
  const modalTitle = document.getElementById("modalTitle");
  const modalLocation = document.getElementById("modalLocation");
  const modalAuditorium = document.getElementById("modalAuditorium");
  const modalDate = document.getElementById("modalDate");
  const modalTime = document.getElementById("modalTime");
  const modalError = document.getElementById("modalError");
  const modalSave = document.getElementById("modalSave");

  const admin = localStorage.getItem('admin');

  if (!admin) {
    alert('Silakan login sebagai admin terlebih dahulu');
    window.location.href = 'admin-login.html';
  }

  /* ===============================
     HELPERS
  ================================ */
  function getFilmId() {
      const params = new URLSearchParams(window.location.search);
      return params.get("filmId");
  }

  function closeScheduleModal() {
      scheduleModal.style.display = "none";
  }

  /* ===============================
     LOAD FILM
  ================================ */
  async function loadFilmTitle() {
      const res = await fetch(`${API_BASE}/films/${filmId}`);
      const film = await res.json();
      document.getElementById("filmTitle").innerText = `Schedule — ${film.title}`;
  }

  async function loadLocations() {
    const res = await fetch(`${API_BASE}/locations`);
    locations = await res.json();
}



  /* ===============================
     MODAL AUDITORIUM
  ================================ */
  async function loadModalAuditoriums(locationId, selectedAudId = null) {
      const res = await fetch(`${API_BASE}/locations/${locationId}/auditoriums`);
      const auds = await res.json();

      modalAuditorium.innerHTML = auds.map(a =>
          `<option value="${a.id}" ${a.id === selectedAudId ? "selected" : ""}>
              ${a.name}
          </option>`
      ).join("");
  }

  modalLocation.addEventListener("change", () => {
      loadModalAuditoriums(modalLocation.value);
  });

  /* ===============================
     ADD SCHEDULE (OPEN MODAL)
  ================================ */
  btnAdd.addEventListener("click", () => {
      mode = "add";
      editingId = null;

      modalTitle.innerText = "Add Schedule";
      modalError.style.display = "none";

      modalDate.value = "";
      modalTime.value = "";

      modalLocation.innerHTML = locations.map(l =>
          `<option value="${l.id}">${l.name}</option>`
      ).join("");

      loadModalAuditoriums(modalLocation.value);

      scheduleModal.style.display = "block";
  });

  /* ===============================
     LOAD SCHEDULE TABLE
  ================================ */
  async function loadSchedules() {
    const res = await fetch(`${API_BASE}/films/${filmId}/schedules`);
    allSchedules = await res.json();

    currentPage = 1;
    renderTable();
}

function renderTable() {
    scheduleTable.innerHTML = "";

    if (!allSchedules.length) {
        scheduleTable.innerHTML = `
          <tr>
            <td colspan="6" style="text-align:center; opacity:0.6">
              No schedules
            </td>
          </tr>
        `;
        pagination.innerHTML = "";
        pageInfo.innerText = "No data";
        return;
    }

    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    const pageData = allSchedules.slice(start, end);

    renderRows(pageData);
    renderPagination(allSchedules.length);

    const totalPages = Math.ceil(allSchedules.length / rowsPerPage);
    pageInfo.innerText = `Showing page ${currentPage} of ${totalPages}`;
}

function renderRows(data) {
    scheduleTable.innerHTML = "";

    data.forEach(s => {
        scheduleTable.innerHTML += `
            <tr>
                <td>${s.id}</td>
                <td>${s.locationName}</td>
                <td>${s.auditoriumName}</td>
                <td>${s.date}</td>
                <td>${s.time}</td>
                <td>
                    <button id="edit-btn" onclick="editSchedule(${s.id})">Edit</button>
                    <button class="delete-btn" onclick="deleteSchedule(${s.id})">Delete</button>
                </td>
            </tr>
        `;
    });
}

function renderPagination(totalItems) {
    const totalPages = Math.ceil(totalItems / rowsPerPage);
    pagination.innerHTML = "";

    const prev = document.createElement("button");
    prev.innerText = "<";
    prev.disabled = currentPage === 1;
    prev.onclick = () => {
        currentPage--;
        renderTable();
    };
    pagination.appendChild(prev);

    for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement("button");
        btn.innerText = i;

        if (i === currentPage) {
            btn.style.background = "#5AC3E7";
            btn.style.color = "#020617";
        }

        btn.onclick = () => {
            currentPage = i;
            renderTable();
        };

        pagination.appendChild(btn);
    }

    const next = document.createElement("button");
    next.innerText = ">";
    next.disabled = currentPage === totalPages;
    next.onclick = () => {
        currentPage++;
        renderTable();
    };
    pagination.appendChild(next);
}


  /* ===============================
     EDIT SCHEDULE (OPEN MODAL)
  ================================ */
  window.editSchedule = async function(id) {
      mode = "edit";
      editingId = id;

      const res = await fetch(`${API_BASE}/films/${filmId}/schedules`);
      const schedules = await res.json();
      const s = schedules.find(sc => sc.id === id);

      modalTitle.innerText = "Edit Schedule";
      modalError.style.display = "none";

      modalDate.value = s.date;
      modalTime.value = s.time;

      modalLocation.innerHTML = locations.map(l =>
          `<option value="${l.id}" ${l.id === s.locationId ? "selected" : ""}>
              ${l.name}
          </option>`
      ).join("");

      await loadModalAuditoriums(s.locationId, s.auditoriumId);

      scheduleModal.style.display = "block";
  };

  /* ===============================
     SAVE (ADD / EDIT)
  ================================ */
  modalSave.onclick = async () => {
      if (!modalDate.value || !modalTime.value) {
          modalError.innerText = "Please fill all fields";
          modalError.style.display = "block";
          return;
      }

      const payload = {
          filmId: Number(filmId),
          locationId: Number(modalLocation.value),
          auditoriumId: Number(modalAuditorium.value),
          date: modalDate.value,
          time: modalTime.value
      };

      const url = mode === "add"
          ? `${API_BASE}/schedules`
          : `${API_BASE}/schedules/${editingId}`;

      const method = mode === "add" ? "POST" : "PUT";

      const res = await fetch(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
      });

      if (!res.ok) {
          const err = await res.json();
          modalError.innerText = err.error || "Failed";
          modalError.style.display = "block";
          return;
      }

      scheduleModal.style.display = "none";
      loadSchedules();
  };


  window.deleteSchedule = async function(id) {
      if (!confirm("Delete schedule?")) return;

      await fetch(`${API_BASE}/schedules/${id}`, {
          method: "DELETE"
      });

      loadSchedules();
  };

  (async function init() {
      filmId = getFilmId();
      if (!filmId) return alert("filmId missing in URL!");

      await loadFilmTitle();
      await loadLocations();
      await loadSchedules();
  })();
</script>
</body>
</html>
