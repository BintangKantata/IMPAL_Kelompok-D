<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Film Detail - Cinemate</title>
  <link href="dist/output.css" rel="stylesheet">

  <style>
    body {
      background: radial-gradient(circle at top left, #0e1a20 0%, #11252d 40%, #0d1418 100%);
      color: #fff;
      font-family: 'Montserrat', Arial, sans-serif;
      min-height: 100vh;
    }

    .detail-card {
      background: rgba(0,0,0,0.15);
      border-radius: 1.5rem;
      padding: 2.5rem;
      max-width: 1000px;
      margin: auto;
    }

    .detail-title {
      font-size: 2rem;
      font-weight: 550;
      margin-bottom: 1rem;
    }

    .detail-table td {
      padding: 6px 10px;
      vertical-align: top;
      font-size: 0.95rem;
    }

    .detail-poster {
      width: 220px;
      height: 320px;
      object-fit: cover;
      border-radius: 1.5rem;
    }

    /* Schedule */
    #schedule-container {
      margin: 40px auto;
      max-width: 1000px;
      background: rgba(0,0,0,0.15);
      border-radius: 1.5rem;
      padding: 2rem;
    }

    ul {
      margin-bottom: 11px;
    }

    .date-buttons button {
      margin: 5px;
      padding: 8px 14px;
      background: rgba(255,255,255,0.15);
      border: none;
      border-radius: 0.6rem;
      cursor: pointer;
      color: white;
      font-weight: 450;
      margin-bottom: 20px;
    }

    .date-buttons button.active {
      background: #5AC3E7;
      font-weight: bold;
      color: white;
    }

    .showtime-lists {
      padding: 0;
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .showtime-lists a {
      padding: 8px 14px;
      background: rgba(0,0,0,0.35);
      border-radius: 0.6rem;
      text-decoration: none;
      color: white;
      font-weight: 600;
    }

    .showtime-lists a:hover {
      background: #5AC3E7;
      color: #fff;
    }

    .schedule-title {
      font-weight: bold;
      color: #5AC3E7;
      margin-top: 20px;
    }

  </style>
</head>

<body>

<header class="flex justify-between items-center px-10 py-5">
  <div class="flex items-center space-x-3">
    <img src="https://img.icons8.com/ios-filled/50/ffffff/video-projector.png" class="w-10 h-10"/>
    <span class="text-white text-2xl font-bold tracking-wide">CINEMATE</span>
  </div>
  <nav><a href="homepage.html" class="text-white text-lg hover:text-blue-400">Home</a></nav>
</header>

<main class="flex justify-center items-start py-10 px-4">
  <div class="detail-card">

    <div class="flex flex-col md:flex-row gap-10">

      <img id="poster" class="detail-poster"
           src="https://via.placeholder.com/300x450?text=No+Image">

      <div>
        <h1 id="film-title" class="detail-title">Loading...</h1>

        <table class="detail-table">
          <tr><td class="font-bold">Genre</td><td id="film-genres"></td></tr>
          <tr><td class="font-bold">Duration</td><td id="film-duration"></td></tr>
          <tr><td class="font-bold">Age Rating</td><td id="film-ru"></td></tr>
          <tr><td class="font-bold">Synopsis</td><td id="film-description"></td></tr>
        </table>
      </div>

    </div>
  </div>
</main>

<div id="schedule-container"></div>

<script>
  const API = "http://localhost:8080/api/admin";

  let filmId = null;
  window.__scheduleData = {};
  window.__activeDate = null;

  async function loadFilmDetails() {
    const params = new URLSearchParams(window.location.search);
    filmId = params.get("id");
    if (!filmId) return;

    try {
      const res = await fetch(`${API}/films/${filmId}`);
      const film = await res.json();

      document.getElementById("film-title").textContent = film.title;
      document.getElementById("film-genres").textContent = (film.genres || []).join(", ");
      document.getElementById("film-duration").textContent = film.duration + " minutes";
      document.getElementById("film-ru").textContent = film.ru || "-";
      document.getElementById("film-description").textContent = film.description;

      document.getElementById("poster").src =
              film.image && film.image.trim() !== "" ? film.image :
                      "https://via.placeholder.com/300x450?text=No+Image";

    } catch (e) {
      console.error("Gagal memuat film:", e);
    }

    loadSchedules();
  }

  function formatDuration(min) {
    const h = Math.floor(min / 60);
    const m = min % 60;
    return h ? `${h}h ${m}m` : `${m}m`;
  }

  async function loadSchedules() {
    const res = await fetch(`${API}/films/${filmId}/schedules`);
    const data = await res.json();

    const groupByDate = {};
    data.forEach(s => {
      if (!groupByDate[s.date]) groupByDate[s.date] = [];
      groupByDate[s.date].push(s);
    });

    window.__scheduleData = groupByDate;

    renderDateButtons(Object.keys(groupByDate));
  }

  function renderDateButtons(dates) {
    const container = document.getElementById("schedule-container");

    container.innerHTML = `
      <div class="date-buttons">
        ${dates.map(d =>
            `<button onclick="showSchedules('${d}')" id="btn-${d}">${d}</button>`
    ).join("")}
      </div>
      <div id="schedule-content"></div>
    `;

    if (dates.length > 0) showSchedules(dates[0]);
  }

  window.showSchedules = function(date) {
    const buttons = document.querySelectorAll(".date-buttons button");
    buttons.forEach(btn => btn.classList.remove("active"));
    document.getElementById(`btn-${date}`).classList.add("active");

    const data = window.__scheduleData[date];
    const content = document.getElementById("schedule-content");

    const byLocation = {};
    data.forEach(s => {
      if (!byLocation[s.locationName]) byLocation[s.locationName] = {};
      if (!byLocation[s.locationName][s.auditoriumName])
        byLocation[s.locationName][s.auditoriumName] = [];
      byLocation[s.locationName][s.auditoriumName].push(s);
    });

    content.innerHTML = Object.keys(byLocation).map(locationName => {
      const audis = byLocation[locationName];

      return `
        <div class="schedule-title">
          <a href="javascript:void(0);">${locationName}</a>
          <span></span>
        </div>

        ${Object.keys(audis).map(audiName => `
          <ul>
            <li class="schedule-type">
              <span class="audi-nm">${audiName}</span>
            </li>

            <li>
              <ul class="showtime-lists">
                ${audis[audiName].map(s => `
                  <li>
                    <a href="booking.html?scheduleId=${s.id}">
                      ${s.time.slice(0,5)}
                    </a>
                  </li>
                `).join("")}
              </ul>
            </li>
          </ul>
        `).join("")}
      `;
    }).join("");
  };


  loadFilmDetails();
</script>
</body>
</html>
